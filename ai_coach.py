from openai import OpenAI
from config import AI_TOKEN, OPENAI_BASE_URL, OPENAI_MODEL, logger, INACTIVITY_THRESHOLD_DAYS
from user_analytics import UserAnalytics
import random
from datetime import datetime


async def ai_fitness_coach(user_message: str, user_id: int, db_session, message_type: str = "general"):
    client = OpenAI(base_url=OPENAI_BASE_URL, api_key=AI_TOKEN)

    # –ü–æ–ª—É—á–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    analytics = UserAnalytics(db_session, user_id)
    stats = analytics.get_user_stats()
    profile = analytics.get_user_profile()
    trend = analytics.get_workout_trend()

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    context = build_user_context(stats, profile, trend, message_type)

    prompt = f"""
    –¢—ã - –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä Spovatar, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –ö–ê–†–î–ò–û —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö.
    –í–∏–¥—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: üö¥ –í–µ–ª–æ—Å–∏–ø–µ–¥, üèÉ –ë–µ–≥, üèä –ü–ª–∞–≤–∞–Ω–∏–µ.

    {context}

    –°–û–û–ë–©–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: "{user_message}"

    –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –î–õ–Ø –ö–ê–†–î–ò–û –¢–†–ï–ù–ò–†–û–í–û–ö:
    1. –î–ª—è –í–ï–õ–û–°–ò–ü–ï–î–ê: —Å–æ–≤–µ—Ç—ã –ø–æ –ø–æ—Å–∞–¥–∫–µ, –∫–∞–¥–µ–Ω—Å—É, –ø–µ—Ä–µ–¥–∞—á–∞–º, —Ç–µ—Ö–Ω–∏–∫–µ –ø–µ–¥–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è
    2. –î–ª—è –ë–ï–ì–ê: —Ç–µ—Ö–Ω–∏–∫–∞ –±–µ–≥–∞, –¥—ã—Ö–∞–Ω–∏–µ, –≤—ã–±–æ—Ä –æ–±—É–≤–∏, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Ç—Ä–∞–≤–º
    3. –î–ª—è –ü–õ–ê–í–ê–ù–ò–Ø: —Ç–µ—Ö–Ω–∏–∫–∞ –≥—Ä–µ–±–∫–∞, –¥—ã—Ö–∞–Ω–∏–µ, –ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–ª–∞ –≤ –≤–æ–¥–µ
    4. –î–∞–≤–∞–π –ö–û–ù–ö–†–ï–¢–ù–´–ï —Ü–∏—Ñ—Ä—ã: —Ç–µ–º–ø, –ø—É–ª—å—Å, –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏, —á–∞—Å—Ç–æ—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    5. –£—á–∏—Ç—ã–≤–∞–π –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏ –Ω–∞–≥—Ä—É–∑–æ–∫ –¥–ª—è –∫–∞—Ä–¥–∏–æ
    6. –†–µ–∫–æ–º–µ–Ω–¥—É–π –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

    –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã! –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ç—Ä–µ–Ω–µ—Ä–æ–º.
    """

    try:
        response = client.chat.completions.create(
            model=OPENAI_MODEL,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.9,
            max_tokens=150
        )
        return response.choices[0].message.content
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ AI: {e}")
        return get_contextual_fallback_response(stats, message_type)


def build_user_context(stats: dict, profile: dict, trend: str, message_type: str) -> str:
    """–°—Ç—Ä–æ–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∫–∞—Ä–¥–∏–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫"""

    base_context = f"""
    –ö–û–ù–¢–ï–ö–°–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–ö–ê–†–î–ò–û):
    - –í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: {stats['total_workouts']}
    - –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∑–∞ –º–µ—Å—è—Ü: {stats['month_workouts']}
    - –î–Ω–µ–π –±–µ–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: {stats['inactivity_days']}
    - –¢—Ä–µ–Ω–¥: {trend}
    - –£—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏: {profile['fitness_level']}
    - –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: {profile['preferred_workouts']}
    """

    if message_type == "workout_completed":
        if "–≤–µ–ª–æ—Å–∏–ø–µ–¥" in user_message.lower():
            base_context += "\n- –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: –í–ï–õ–û–°–ò–ü–ï–î - –¥–∞–π —Å–æ–≤–µ—Ç –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ –ø–µ–¥–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –≤—ã–±–æ—Ä—É –º–∞—Ä—à—Ä—É—Ç–∞"
        elif "–±–µ–≥" in user_message.lower():
            base_context += "\n- –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: –ë–ï–ì - –ø–æ—Å–æ–≤–µ—Ç—É–π –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ –±–µ–≥–∞ –∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–µ —Ç—Ä–∞–≤–º"
        elif "–ø–ª–∞–≤–∞–Ω–∏–µ" in user_message.lower():
            base_context += "\n- –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: –ü–õ–ê–í–ê–ù–ò–ï - —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ –ø–ª–∞–≤–∞–Ω–∏—è –∏–ª–∏ –¥—ã—Ö–∞–Ω–∏—é"

    if stats['is_inactive']:
        base_context += f"\n‚ö†Ô∏è –ü–µ—Ä–µ—Ä—ã–≤ {stats['inactivity_days']} –¥–Ω–µ–π! –ü—Ä–µ–¥–ª–æ–∂–∏ –õ–ï–ì–ö–£–Æ –∫–∞—Ä–¥–∏–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –¥–ª—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è."

    return base_context


def get_contextual_fallback_response(stats: dict, message_type: str) -> str:
    """–£–º–Ω—ã–µ –∑–∞–ø–∞—Å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –∫–∞—Ä–¥–∏–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫"""

    cardio_advice = [
        "–û—Ç–ª–∏—á–Ω–∞—è –∫–∞—Ä–¥–∏–æ —Ä–∞–±–æ—Ç–∞! –°–æ–≤–µ—Ç: —Å–ª–µ–¥–∏ –∑–∞ –ø—É–ª—å—Å–æ–º –≤ –∑–æ–Ω–µ 120-150 —É–¥/–º–∏–Ω –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è. üíì",
        "–•–æ—Ä–æ—à–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞! –î–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: –¥–æ–±–∞–≤—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã 30 —Å–µ–∫ —É—Å–∫–æ—Ä–µ–Ω–∏–µ/90 —Å–µ–∫ –æ—Ç–¥—ã—Ö. ‚è±Ô∏è",
        "–ó–∞–ø–∏—Å–∞–ª! –†–µ–∫–æ–º–µ–Ω–¥—É—é: 2 —Å–∏–ª–æ–≤—ã–µ –≤ –Ω–µ–¥–µ–ª—é —É–∫—Ä–µ–ø—è—Ç –º—ã—à—Ü—ã –¥–ª—è –ª—É—á—à–∏—Ö –∫–∞—Ä–¥–∏–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. üí™",
        "–°—É–ø–µ—Ä! –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: —Ä–∞—Å—Ç—è–∂–∫–∞ –∫–≤–∞–¥—Ä–∏—Ü–µ–ø—Å–æ–≤ –∏ –ø–æ–¥–∫–æ–ª–µ–Ω–Ω—ã—Ö —Å—É—Ö–æ–∂–∏–ª–∏–π 10 –º–∏–Ω—É—Ç. üßò‚Äç‚ôÄÔ∏è",
        "–û—Ç–ª–∏—á–Ω–æ! –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –≤–∞–∂–Ω–∞: 500–º–ª –≤–æ–¥—ã –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. üíß"
    ]

    if message_type == "workout_completed":
        responses = [
            f"–ö–∞—Ä–¥–∏–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∞–Ω–∞! –í—Å–µ–≥–æ: {stats['total_workouts']}. " + random.choice(cardio_advice),
            f"–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª! {stats['month_workouts']} –∫–∞—Ä–¥–∏–æ –∑–∞ –º–µ—Å—è—Ü. " + random.choice(cardio_advice),
            f"–î–æ–±–∞–≤–∏–ª –≤ –∏—Å—Ç–æ—Ä–∏—é! –¢—Ä–µ–Ω–¥: {stats['week_workouts']}/–Ω–µ–¥. " + random.choice(cardio_advice)
        ]

    elif stats['is_inactive']:
        responses = [
            f"–ü–µ—Ä–µ—Ä—ã–≤ {stats['inactivity_days']} –¥–Ω–µ–π... üòî –ü—Ä–µ–¥–ª–∞–≥–∞—é –ª–µ–≥–∫–æ–µ –∫–∞—Ä–¥–∏–æ: 20 –º–∏–Ω –≤–µ–ª–æ—Å–∏–ø–µ–¥ –≤ —Å–ø–æ–∫–æ–π–Ω–æ–º —Ç–µ–º–ø–µ. üö¥‚Äç‚ôÄÔ∏è",
            f"–ó–∞–º–µ—Ç–∏–ª –ø–∞—É–∑—É {stats['inactivity_days']} –¥–Ω–µ–π. –ù–∞—á–Ω–∏ —Å –±—ã—Å—Ç—Ä–æ–π —Ö–æ–¥—å–±—ã 30 –º–∏–Ω—É—Ç –¥–ª—è –º—è–≥–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è. üö∂‚Äç‚ôÇÔ∏è",
            f"{stats['inactivity_days']} –¥–Ω–µ–π –±–µ–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫... –õ–µ–≥–∫–æ–µ –ø–ª–∞–≤–∞–Ω–∏–µ 20 –º–∏–Ω—É—Ç –ø–æ–º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ —Ä–∏—Ç–º. üèä‚Äç‚ôÄÔ∏è"
        ]

    else:
        responses = cardio_advice

    return random.choice(responses)


async def analyze_workout_pattern(user_id: int, db_session) -> str:
    """–ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∫–∞—Ä–¥–∏–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫"""
    analytics = UserAnalytics(db_session, user_id)
    stats = analytics.get_user_stats()

    if stats['week_workouts'] == 0:
        return "–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ –µ—â–µ –Ω–µ –±—ã–ª–æ –∫–∞—Ä–¥–∏–æ. –ù–∞—á–Ω–∏ —Å –ª–µ–≥–∫–æ–π 20-–º–∏–Ω—É—Ç–Ω–æ–π —Å–µ—Å—Å–∏–∏."
    elif stats['week_workouts'] >= 5:
        return "–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è –∫–∞—Ä–¥–∏–æ –Ω–µ–¥–µ–ª—è! –°–µ–≥–æ–¥–Ω—è –ª—É—á—à–µ –æ—Ç–¥—ã—Ö –∏–ª–∏ –ª–µ–≥–∫–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞."
    elif stats['inactivity_days'] > 2:
        return "–ù–µ–±–æ–ª—å—à–æ–π –ø–µ—Ä–µ—Ä—ã–≤. –í–µ—Ä–Ω–∏—Å—å —Å —É–º–µ—Ä–µ–Ω–Ω—ã–º –∫–∞—Ä–¥–∏–æ 25-30 –º–∏–Ω—É—Ç."

    return "–°—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–∞—Ä–¥–∏–æ –ø—Ä–æ–≥—Ä–µ—Å—Å. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏."